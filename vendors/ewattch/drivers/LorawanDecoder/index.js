var FRAME_TYPE_SENSOR=0,FRAME_TYPE_STATUS=1,LW_TIC_TYPES={"0E":"Données erronées","0F":"Compteur Inconnu",10:"Bleu","1F":"Bleu avec defaut",20:"Jaune","2F":"Jaune avec defaut",30:"PME-PMI","3F":"PME-PMI avec defaut",40:"ICE","4E":"ICE V2.4","4F":"ICE avec defaut",50:"Linky",51:"Linky Injection","5F":"Linky avec defaut",60:"Saphir","6F":"Saphir avec defaut"},LW_SUBS_BLEU={"00":"Base","01":"HP/HC","02":"EJP","03":"TEMPO"},LW_TARIFS_BLEU={"00":"Base","01":"HC","02":"HP","03":"EJP heures normales","04":"EJP heures de pointe mobile","05":"TEMPO HC Jour Bleu","06":"TEMPO HC Jour Blanc","07":"TEMPO HC Jour Rouge","08":"TEMPO HP Jour Bleu","09":"TEMPO HP Jour Blanc","0a":"TEMPO HP Jour Rouge"},LW_SEASON_JAUNE={"01":"Ete","02":"Hiver","03":"Pointe mobile"},LW_TARIF_JAUNE={"01":"Heures Pleines","02":"Heures Creuses","03":"Heures de pointe","04":"Heures de pointe mobile"},LW_SUBS_PME_PMI={"00":"TJ MU","01":"TJ LU","02":"TJ LU-SD","03":"TJ LU-P","04":"TJ LU-PH","05":"TJ LU-CH","06":"TJ EJP","07":"TJ EJP-SD","08":"TJ EJP-PM","09":"TJ EJP-HH","0a":"TV A5 Base","0b":"TV A8 Base","0c":"BT 4 SUP36","0d":"BT 5 SUP36","0e":"HTA 5","0f":"HTA 8"},LW_TARIFS_PME_PMI={"00":"P","01":"PM","02":"HH","03":"HP","04":"HC","05":"HPH","06":"HCH","07":"HPE","08":"HCE","09":"HPD","0a":"HCD","0b":"JA"},LW_SUBS_ICE={"0a":"TV A5 Base","0b":"TV A8 Base",10:"TV A5 EJP",11:"TV A8 EJP",12:"TV A8 MOD"},LW_TARIFS_ICE={"00":"P","01":"PM","02":"HH","03":"HP","04":"HC","05":"HPH","06":"HCH","07":"HPE","08":"HCE","09":"HPD","0a":"HCD","0b":"JA","0c":"HD","0d":"HM","0e":"DSM","0f":"SCM"},NODE_TYPE_LIST={"00":"environnement","01":"presence","02":"ambiance","08":"squid",10:"impulse",20:"tyness",28:"tynode"};function manageDigitalInput(e,a,t,r){for(var n=[],u=e[0],i=0;i<r;i++)n.push({uuid:"digital_input_s"+a+"_c"+(t+i),hardwareData:{socket:a,channel:t+i},type:"boolean",value:1&u,unit:""}),u>>=1;return e.splice(0,2),n}function manageSquid(e,a,t){for(var r=0,n=[],u=0;u<12;u++)n.push({type:"currentIndex",hardwareData:{socket:a,channel:t+u},uuid:"clamp_s"+a+"_c"+(t+u),value:10*(e[r]|e[r+1]<<8|e[r+2]<<16),unit:"mAh"}),r+=3;return e.splice(0,r),n}function manageAnalogInput(e,a,t){var r,n,u=(224&e[0])>>5?.001:.01;return 0==(31&e[0])?(r="mA",n="4:20"):1==(31&e[0])?(r="V",n="0:10"):2==(31&e[0])&&(r="V",n="0:24"),{uuid:"analog_input_s"+a+"_c"+t,hardwareData:{socket:a,channel:t,scale:n},type:"analogInput",value:signed16(e[1]|e[2]<<8)*u,unit:r}}function manageEnergy(e,a,t){var r=0,n=(240&e[r])>>4,u=15&e[r],i=[];switch(r++,u){case 0:for(var c=0;c<n;c++)i.push({type:"currentIndex",hardwareData:{socket:a,channel:t+c},uuid:"clamp_s"+a+"_c"+(t+c),value:10*(e[r]|e[r+1]<<8|e[r+2]<<16),unit:"mAh"}),r+=3;break;case 1:for(c=0;c<n;c++)i.push({type:"current",hardwareData:{socket:a,channel:t+c},uuid:"clamp_s"+a+"_c"+(t+c),value:e[r]|e[r+1]<<8|e[r+2]<<16,unit:"mA"}),r+=3;break;case 2:for(c=0;c<n;c++)i.push({type:"currentIndex",hardwareData:{socket:a,channel:t+c},uuid:"clamp_s"+a+"_c"+(t+c),value:10*(e[r]|e[r+1]<<8|e[r+2]<<16),unit:"mAh"}),r+=3;for(c=0;c<n;c++)i.push({type:"current",hardwareData:{socket:a,channel:t+c},uuid:"clamp_s"+a+"_c"+(t+c),value:e[r]|e[r+1]<<8|e[r+2]<<16,unit:"mA"}),r+=3;break;default:var s={3:["consumedActiveEnergyIndex",10,"Wh"],4:["power",1,"W"],5:["producedActiveEnergyIndex",10,"Wh"],6:["positiveReactiveEnergyIndex",10,"varh"],7:["negativeReactiveEnergyIndex",10,"varh"],8:["reactivePower",1,"var"],9:["apparentEnergyIndex",10,"VAh"],10:["voltage",.1,"V"],11:["apparentPower",1,"VA"],12:["frequency",.01,"hZ"]}[u.toString()];if(null==s)return"No such measure code";for(var o=10===u||12===u?2:3,c=0;c<n;c++)i.push({type:s[0],hardwareData:{socket:a,channel:t+c},uuid:"clamp_s"+a+"_c"+(t+c),value:(2==o?e[r]|e[r+1]<<8:e[r]|e[r+1]<<8|e[r+2]<<16)*s[1],unit:s[2]}),r+=o}return e.splice(0,r),i}function manageTIC(e,a,t){var r=0,n={uuid:"tic_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"tic",values:[],metadata:{}},a=e[r];r++;var u,i,c=0,s=0,o=(15==(15&a)||14==(15&a)||0===a?(n.metadata.counterError=LW_TIC_TYPES[a.toString(16).toUpperCase().padStart(2,"0")]||"error code 0x"+a.toString(16).padStart(2,"0"),e.splice(0,r)):n.metadata.counterType=LW_TIC_TYPES[a.toString(16).toUpperCase().padStart(2,"0")],[]);switch(a){case 16:switch(n.metadata.checksum=e[1],s=31&(u=e[2]),n.metadata.subscription=LW_SUBS_BLEU[(c=(224&u)>>5&7).toString(16).toUpperCase().padStart(2,"0")],n.metadata.tarrifPeriod=LW_TARIFS_BLEU[s.toString(16).toUpperCase().padStart(2,"0")],r+=2,c){case 0:o=["Base"];break;case 1:o=["HC","HP"];break;case 2:o=["Heures Normales","Heures Pointe mobile"];break;case 3:o=["HC Jour bleu","HC Jour blanc","HC Jour rouge","HP Jour bleu","HP Jour blanc","HP Jour rouge"]}for(var d=0;d<o.length;d++)i=o[d],n.values.push({type:i,value:e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,unit:"Wh"}),r+=4;break;case 32:s=15&(u=e[r]),n.metadata.subscription=LW_SEASON_JAUNE[(c=(240&u)>>4&15).toString(16).toUpperCase().padStart(2,"0")],n.metadata.tarrifPeriod=LW_TARIF_JAUNE[s.toString(16).toUpperCase().padStart(2,"0")],r++;for(o=["1","2","3","4"],d=0;d<o.length;d++)i=o[d],n.values.push({value:e[r]|e[r+1]<<8|e[r+2]<<16,unit:"kWh"}),r+=3;break;case 48:c=e[r],n.metadata.subscription=LW_SUBS_PME_PMI[c.toString(16).toUpperCase().padStart(2,"0")],s=e[++r],n.metadata.tarrifPeriod=LW_TARIFS_PME_PMI[s.toString(16).toUpperCase().padStart(2,"0")],r++,o=["ActiveEnergyCurrentPeriode","PositiveReactiveEnergyCurrentPeriode","NegativeReactiveEnergyCurrentPeriode","ActiveEnergyPreviousPeriode","PositiveReactiveEnergyPreviousPeriode","NegativeReactiveEnergyPreviousPeriode"];for(d=0;d<o.length;d++)i=o[d],n.values.push({type:i,value:e[r]|e[r+1]<<8|e[r+2]<<16,unit:d%3==0?"kWh":"kVarh"}),r+=3;break;case 64:switch(c=e[r],n.metadata.subscription=LW_SUBS_ICE[c.toString(16).toUpperCase().padStart(2,"0")],s=e[++r],n.metadata.tarrifPeriod=LW_TARIFS_ICE[s.toString(16).toUpperCase().padStart(2,"0")],n.values.activePower10Minutes={value:e[++r]|e[r+1]<<8,unit:"kW"},n.values.reactivePower10Minutes={value:e[r+=2]|e[r+1]<<8,unit:"kVar"},r+=2,c){case 10:o=["P","HPH","HCH","HPE","HCE"];break;case 11:o=["P","HPH","HCH","HPD","HCD","HPE","HCE","JA"];break;case 16:o=["PM","HH","HPE","HCE"];break;case 17:o=["PM","HH","HD","HPE","HCE","JA"];break;case 18:o=["PM","HM","DSM","SCM"]}for(d=0;d<o.length;d++)i=o[d],n.values.push({type:i,value:e[r]|e[r+1]<<8|e[r+2]<<16,unit:"kWh"}),r+=3;break;case 80:n.metadata.checksum=e[r],n.metadata.tarrifPeriod=31&(s=e[++r]),n.values.push({value:e[++r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,unit:"Wh"}),r+=4;break;case 81:n.metadata.checksum=e[r],n.metadata.tarrifPeriod=31&(s=e[++r]),n.values.push({value:e[++r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,unit:"Wh"}),n.values.push({value:e[r+=4]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,unit:"Wh"}),r+=4;break;case 96:n.metadata.checksum=e[r],r++,n.metadata.tarrifPeriod=String.fromCharCode(e[r])+String.fromCharCode(e[r+1])+String.fromCharCode(e[r+2]),n.values.push({type:"tgphis",value:signed16(e[r+=3]|e[r+1]<<8)/100,unit:""}),r+=2,o=["1","2","3","4","5","6","7","8"];for(d=0;d<o.length;d++)i=o[d],n.values.push({value:e[r]|e[r+1]<<8|e[r+2]<<16|e[r+3]<<24,unit:"Wh"}),r+=4}return e.splice(0,r),n}function manageMBus(e,a,t){var r={uuid:"mbus_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"mbus",values:[],metadata:{}},a=e[0],n=(240&e[1])>>4,u=15&e[1];switch(n){case 0:r.metadata.device_name="HEAT METER";break;case 1:r.metadata.device_name="WATER METER";break;case 2:r.metadata.device_name="ELECTRICITY METER";break;case 3:r.metadata.device_name="GAZ METER";break;default:return e.splice(0,1),r.metadata.error="Unkwown meter code 0x"+n.toString(16),r}r.metadata.device_slave_adress=a,e.splice(0,2);for(var i=0;0<e.length&&i<u;){var c=1&e[0],s=(254&e[0]).toString(16).toUpperCase().padStart(2,"00"),o=EWATTCH_SENSOR[s];if(null==o)return r.metadata.error="Unkwown object type 0x"+s.toString(16),r;e.splice(0,1);var s=0,d=0;c&&(s=(224&e[0])>>5,d=31&e[0],e.splice(0,1)),c=o[1](e,s,d),Array.isArray(c)?r.values=r.values.concat(c):r.values.push(c),e.splice(0,o[0]),i++}return r}function manageModBus(e,a,t){var r=0,n={uuid:"modbus_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"modbus",values:[],metadata:{}},a=e[++r],u=(n.metadata.application_code=63&a,n.metadata.standardised=(64&a)>>7==1,e[++r]);switch(u){case 3:n.metadata.command="Read Holding Registers";break;case 4:n.metadata.command="Read Input Registers";break;case 8:n.metadata.command="Read Diagnostics";break;case 16:n.metadata.command="Write Multiples Registers Response";break;case 80:n.metadata.command="Master Write Multiples Registers Response";break;default:n.metadata.command="Unknown command : "+(127&u)}if(r++,3===u||4===u){n.metadata.startAdress=(e[r+1]<<8)+e[r],n.metadata.wordCount=e[r+=2]/2,r++;for(var i=[],c=0;c<n.metadata.wordCount&&!(r+1>e.length);)i.push((e[r+1]<<8)+e[r]),r+=2,c++;n.values=i}return e.splice(0,r),n}var EWATTCH_SENSOR={"00":[2,function(e,a,t){return{uuid:"temperature_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"temperature",value:signed16(e[0]|e[1]<<8)/100,unit:"°C"}},function(e,a){return"temperature_s"+e+"_c"+a}],"04":[1,function(e,a,t){return{uuid:"humidity_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"humidity",value:e[0]/2,unit:"%RH"}},function(e,a){return"humidity_s"+e+"_c"+a}],"06":[2,function(e,a,t){return{uuid:"pressure_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"pressure",value:5*(e[0]|e[1]<<8),unit:"pa"}},function(e,a){return"pressure_s"+e+"_c"+a}],"08":[2,function(e,a,t){return{uuid:"C02_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"co2",value:e[0]|e[1]<<8,unit:"ppm"}},function(e,a){return"C02_s"+e+"_c"+a}],"0C":[2,function(e,a,t){return{uuid:"counter_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"counter",value:e[0]|e[1]<<8,unit:""}},function(e,a){return"counter_s"+e+"_c"+a}],"0E":[3,function(e,a,t){return{uuid:"time_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"time",value:e[0]|e[1]<<8|e[2]<<16,unit:"s"}},function(e,a){return"time_s"+e+"_c"+a}],10:[2,function(e,a,t){return{uuid:"luminosity_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"luminosity",value:e[0]|e[1]<<8,unit:"lx"}},function(e,a){return"luminosity_s"+e+"_c"+a}],14:[2,function(e,a,t){return{uuid:"motion_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"motion",value:10*(e[0]|e[1]<<8),unit:"s"}},function(e,a){return"motion_s"+e+"_c"+a}],16:[2,function(e,a,t){return{uuid:"pressure_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"pressure",value:signed16(e[0]|e[1]<<8)/100,unit:"barg"}},function(e,a){return"pressure_s"+e+"_c"+a}],18:[2,function(e,a,t){return{uuid:"flow_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"flow",value:(e[0]|e[1]<<8)/100,unit:"m3/h"}},function(e,a){return"flow_s"+e+"_c"+a}],"1A":[2,function(e,a,t){return{uuid:"volume_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"volume",value:e[0]|e[1]<<8,unit:"m3"}},function(e,a){return"volume_s"+e+"_c"+a}],"1C":[4,function(e,a,t){return{uuid:"volume_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"volume",value:float(e[0]|e[1]<<8|e[2]<<16|e[3]<<24),unit:"m3"}},function(e,a){return"volume_s"+e+"_c"+a}],20:[1,function(e,a,t){return manageDigitalInput(e,a,t,1)},function(e,a){return"digital_input_s"+e+"_c"+a}],22:[1,function(e,a,t){return manageDigitalInput(e,a,t,2)},function(e,a){return"digital_input_s"+e+"_c"+a}],24:[1,function(e,a,t){return manageDigitalInput(e,a,t,4)},function(e,a){return"digital_input_s"+e+"_c"+a}],26:[1,function(e,a,t){return manageDigitalInput(e,a,t,8)},function(e,a){return"digital_input_s"+e+"_c"+a}],28:[3,manageAnalogInput,function(e,a){return"analog_input_s"+e+"_c"+a}],40:[0,manageEnergy,function(e,a){return"clamp_s"+e+"_c"+a}],44:[4,function(e,a,t){return{uuid:"active_energy_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"activeEnergyIndex",value:e[0]|e[1]<<8|e[2]<<16|e[3]<<24,unit:"kWh"}},function(e,a){return"active_energy_s"+e+"_c"+a}],46:[4,function(e,a,t){return{uuid:"reactive_energy_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"reactiveEnergyIndex",value:e[0]|e[1]<<8|e[2]<<16|e[3]<<24,unit:"kvarh"}},function(e,a){return"reactive_energy_s"+e+"_c"+a}],48:[0,manageSquid,function(e,a){return"clamp_s"+e+"_c"+a}],50:[0,manageTIC,function(e,a){return"tic_s"+e+"_c"+a}],58:[0,manageMBus,function(e,a){return"mbus_s"+e+"_c"+a}],"5C":[0,manageModBus,function(e,a){return"modbus_s"+e+"_c"+a}],74:[1,function(e,a,t){return{uuid:"battery_s"+a+"_c"+t,hardwareData:{socket:a,channel:t},type:"battery",value:e,unit:""}},function(e,a){return"battery_s"+e+"_c"+a}]},EWATTCH_STATUS={"00":[1,function(e,a,t){return{value:NODE_TYPE_LIST[e[0].toString(16).toUpperCase().padStart(2,"00")],type:"nodeType"}}],"02":[2,function(e,a,t){return{value:e[1]+"."+e[0],type:"version"}}],"04":[1,function(e,a,t){return{value:e[0],type:"batteryLevel"}}],"08":[2,function(e,a,t){return{value:10*(e[0]|e[1]<<8),type:"periodicity"}}]};function signed16(e){return 32768&e&&(e-=65536),e}function signed8(e){return 128&e&&(e-=256),e}function float(e){var a,t=0===(t=(2139095040&e)>>23)?(a=!0,-149):(a=!1,t-127-23),r=8388607&e;return!1===a&&(r|=8388608),2147483648&e?-Math.pow(2,t)*r:Math.pow(2,t)*r}function decodeUplink(e){var a=e.bytes,e=!0;if("string"==typeof a){for(var t=[],r=0,n=a.length;r<n;r+=2)t.push(parseInt(a.substr(r,2),16));a=t}var u=[],i=[],c=FRAME_TYPE_SENSOR;if(e===null?true:e){c=0===a[0]?FRAME_TYPE_SENSOR:FRAME_TYPE_STATUS;if(a[1]!==a.length-2)return i.push("Payload size indicated does not match payload size given"),{errors:i};a.splice(0,2)}for(;0<a.length;){var s,o=1&a[0],d=128==(128&a[0]),p=(126&a[0]).toString(16).toUpperCase().padStart(2,"00");if(null==(s=(c===FRAME_TYPE_SENSOR?EWATTCH_SENSOR:EWATTCH_STATUS)[p]))return i.push("Unknown object type : "+p),{data:{datapoints:u},errors:i};a.splice(0,1);var p=0,l=0;c===FRAME_TYPE_SENSOR&&o&&(p=(224&a[0])>>5,l=31&a[0],a.splice(0,1)),d?(u.push({uuid:s[2](p,l),hardwareData:{socket:p,channel:l},type:"error"}),a.splice(0,1)):(o=s[1](a,p,l),Array.isArray(o)?u=u.concat(o):u.push(o),a.splice(0,s[0]))}return{data:{datapoints:u}}}String.prototype.padStart||(String.prototype.padStart=function(e,a){return e>>=0,a=String(void 0!==a?a:" "),this.length>e?String(this):((e-=this.length)>a.length&&(a+=a.repeat(e/a.length)),a.slice(0,e)+String(this))}),exports.decodeUplink=decodeUplink;